/**
 * OpenCode Hooks Configuration
 * Auto-generated by agent-skills build system
 */

import { execFileSync } from 'child_process';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const HOOKS_DIR = join(__dirname, 'hooks');

/**
 * Execute a hook script safely using execFile (prevents shell injection)
 */
function runHook(script, context) {
  try {
    const scriptPath = join(HOOKS_DIR, script);
    const result = execFileSync('bash', [scriptPath], {
      cwd: context.workingDir || process.cwd(),
      env: {
        ...process.env,
        TOOL_NAME: context.toolName || '',
        TOOL_INPUT: JSON.stringify(context.toolInput || {}),
        FILE_PATH: context.filePath || '',
      },
      encoding: 'utf-8',
      timeout: context.timeout || 60000,
    });
    return { success: true, output: result };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

/**
 * Check if tool matches pattern
 */
function matchesTool(toolName, pattern) {
  const patterns = pattern.split('|');
  return patterns.includes(toolName);
}

/**
 * Pre-tool hooks by matcher
 */
const preToolHooks = {
  'Edit|Write': [
    { id: 'check-secrets', script: 'pre-tool/foundations-check-secrets.sh', timeout: 30000 },
    { id: 'validate-changelog', script: 'pre-tool/foundations-validate-changelog.sh', timeout: 30000 },
    { id: 'format-check', script: 'pre-tool/foundations-format-check.sh', timeout: 60000 },
    { id: 'python-type-check', script: 'pre-tool/python-type-check.sh', timeout: 60000 },
    { id: 'python-pytest-validation', script: 'pre-tool/python-pytest-validation.sh', timeout: 120000 },
    { id: 'python-type-check-progressive', script: 'pre-tool/python-type-check-progressive.sh', timeout: 120000 },
    { id: 'python-ruff-lint', script: 'pre-tool/python-ruff-lint.sh', timeout: 30000 },
    { id: 'python-pytest-execution', script: 'pre-tool/python-pytest-execution.sh', timeout: 480000 },
    { id: 'python-bandit-scan', script: 'pre-tool/python-bandit-scan.sh', timeout: 60000 },
    { id: 'typescript-tsc-check', script: 'pre-tool/typescript-tsc-check.sh', timeout: 60000 },
    { id: 'typescript-bundle-analysis', script: 'pre-tool/typescript-bundle-analysis.sh', timeout: 60000 },
    { id: 'rails-migration-safety', script: 'pre-tool/rails-migration-safety.sh', timeout: 60000 },
    { id: 'rails-migration-safety-deep', script: 'pre-tool/rails-migration-safety-deep.sh', timeout: 300000 },
    { id: 'rails-test-execution', script: 'pre-tool/rails-test-execution.sh', timeout: 480000 },
    { id: 'rails-brakeman-scan', script: 'pre-tool/rails-brakeman-scan.sh', timeout: 120000 },
    { id: 'infra-validate-k8s', script: 'pre-tool/infra-validate-k8s.sh', timeout: 60000 },
    { id: 'infra-dockerfile-lint', script: 'pre-tool/infra-dockerfile-lint.sh', timeout: 30000 },
    { id: 'infra-k8s-dry-run', script: 'pre-tool/infra-k8s-dry-run-server.sh', timeout: 120000 },
    { id: 'infra-terraform-plan', script: 'pre-tool/infra-terraform-plan-cost.sh', timeout: 300000 },
  ],
  'Bash': [
    { id: 'security-audit', script: 'pre-tool/foundations-security-audit.sh', timeout: 600000 },
    { id: 'validate-commit', script: 'pre-tool/orchestration-validate-commit.py', timeout: 30000 },
    { id: 'detect-linear-magic', script: 'pre-tool/orchestration-detect-linear-magic.py', timeout: 30000 },
  ],
};

/**
 * Post-tool hooks by matcher
 */
const postToolHooks = {
  'Edit|Write': [
    { id: 'python-ruff-check', script: 'post-tool/python-ruff-check.sh' },
    { id: 'typescript-eslint-check', script: 'post-tool/typescript-eslint-check.sh' },
    { id: 'rails-rubocop-check', script: 'post-tool/rails-rubocop-check.sh' },
    { id: 'design-a11y-validation', script: 'post-tool/design-a11y-validation.sh' },
    { id: 'design-token-check', script: 'post-tool/design-token-check.sh' },
    { id: 'design-a11y-audit', script: 'post-tool/design-a11y-audit.sh' },
  ],
};

/**
 * Session hooks
 */
const sessionHooks = {
  'sessionstart': { id: 'session-start', script: 'session/session-start.sh', timeout: 60000 },
  'sessionend': { id: 'session-end', script: 'session/session-end.sh', timeout: 60000 },
  'precompact': { id: 'pre-compact-archive', script: 'session/pre-compact-archive.sh', timeout: 60000 },
};

/**
 * Hook handlers
 */
export const hooks = {
  'tool.execute.pre': async (context) => {
    const results = [];
    for (const [matcher, hookList] of Object.entries(preToolHooks)) {
      if (matchesTool(context.toolName, matcher)) {
        for (const hook of hookList) {
          results.push(runHook(hook.script, { ...context, timeout: hook.timeout }));
        }
      }
    }
    return results;
  },

  'tool.execute.post': async (context) => {
    const results = [];
    for (const [matcher, hookList] of Object.entries(postToolHooks)) {
      if (matchesTool(context.toolName, matcher)) {
        for (const hook of hookList) {
          results.push(runHook(hook.script, context));
        }
      }
    }
    return results;
  },

  'session.start': async (context) => {
    if (sessionHooks.sessionstart) {
      return runHook(sessionHooks.sessionstart.script, context);
    }
  },

  'session.end': async (context) => {
    if (sessionHooks.sessionend) {
      return runHook(sessionHooks.sessionend.script, context);
    }
  },
};

export default hooks;
